**Лабораторная работа - Настройка NAT для IPv4**

**Лабораторная работа - Настройка NAT для IPv4**

# **Топология**
![There are 2 routers, 2 switches, and 2 PCs in this topology. Router R2 has a loopback interface. Router R2 g0/0/0 is connected to R1 G0/0/0. Router R1 G0/0/1 is connected to S1 F0/5.  S1 F0/1 is connected S2 F0/1. S1 F0/6 is connected to PC-A. S2 F0/18 is connected to PC-B.](Aspose.Words.659fe5a7-3a60-4f62-bf15-ad4f22e49b89.001.png)
# **Таблица адресации**

|**Устройство**|**Интерфейс**|**IP-адрес**|**Маска подсети** |
| :-: | :-: | :-: | :-: |
|R1|G0/0/0|209\.165.200.230|255\.255.255.248|
|*R1*|G0/0/1|192\.168.1.1|255\.255.255.0|
|R2|G0/0/0|209\.165.200.225|255\.255.255.248|
|*R2*|Lo1|209\.165.200.1|255\.255.255.224|
|S1|VLAN 1|192\.168.1.11|255\.255.255.0|
|S2|VLAN 1|192\.168.1.12|255\.255.255.0|
|PC-A|NIC|192\.168.1.2|255\.255.255.0|
|PC-B|NIC|192\.168.1.3|255\.255.255.0|
# **Цели**
**Часть 1. Создание сети и настройка основных параметров устройства**

**Часть 2. Настройка и проверка NAT для IPv4**

**Часть 3. Настройка и проверка PAT для IPv4**

**Часть 4. Настройка и проверка статического NAT для IPv4.**
# **Общие сведения/сценарий**
Преобразование (NAT) — это процесс, при котором сетевое устройство, например маршрутизатор Cisco, назначает публичный адрес узлам в пределах частной сети. NAT используют для сокращения количества публичных IP-адресов, используемых организацией, поскольку количество доступных публичных IPv4-адресов ограничено.

Интернет-провайдер выделил компании общедоступное пространство IP-адресов 209.165.200.224/29. Эта сеть используется для обращения к каналу между маршрутизатором ISP (R2) и шлюзом компании (R1). Первый адрес (209.165.200.225) назначается интерфейсу g0/0 на R2, а последний адрес (209.165.200.230) назначается интерфейсу g0/0/0 на R1. Остальные адреса (209.165.200.226-209.165.200.229) будут использоваться для предоставления доступа в Интернет хостам компании. Маршрут по умолчанию используется от R1 до R2. Подключение интернет-провайдера к Интернету смоделировано loopback-адресом на маршрутизаторе интернет-провайдера.

В этой лабораторной работе  вы будете настраивать различные типы NAT. Вы выполните тестирование, отображение и проверку осуществления всех преобразований и проанализируете статистику NAT/PAT для контроля процесса.

**Примечание**: Маршрутизаторы, используемые в практических лабораторных работах CCNA, - это Cisco 4221 с Cisco IOS XE Release 16.9.3 (образ universalk9). В лабораторных работах используются коммутаторы Cisco Catalyst 2960 с Cisco IOS версии 15.2(2) (образ lanbasek9). Можно использовать другие маршрутизаторы, коммутаторы и версии Cisco IOS. В зависимости от модели устройства и версии Cisco IOS доступные команды и результаты их выполнения могут отличаться от тех, которые показаны в лабораторных работах. Правильные идентификаторы интерфейса см. в сводной таблице по интерфейсам маршрутизаторов в конце лабораторной работы.

**Примечание.** Убедитесь, что у всех маршрутизаторов и коммутаторов была удалена начальная конфигурация. Если вы не уверены в этом, обратитесь к инструктору.
# **Необходимые ресурсы**
- 2 маршрутизатора (Cisco 4221 с универсальным образом Cisco IOS XE версии 16.9.4 или аналогичным)
- 2 коммутатора (Cisco 2960 с операционной системой Cisco IOS 15.2(2) (образ lanbasek9) или аналогичная модель)
- 2 ПК (ОС Windows с программой эмуляции терминалов, такой как Tera Term)
- Консольные кабели для настройки устройств Cisco IOS через консольные порты.
- Кабели Ethernet, расположенные в соответствии с топологией
  # **Инструкции**
  1. ## **Создание сети и настройка основных параметров устройства**
В первой части лабораторной работы вам предстоит создать топологию сети и настроить базовые параметры для узлов ПК и коммутаторов.
1. ### **Подключите кабели сети согласно приведенной топологии.**
Подключите устройства в соответствии с топологией и подсоедините соответствующие кабели.
1. ### **Произведите базовую настройку маршрутизаторов.**
   *Откройте окно конфигурации*

   1. Назначьте маршрутизатору имя устройства.
   1. Отключите поиск DNS, чтобы предотвратить попытки маршрутизатора неверно преобразовывать введенные команды таким образом, как будто они являются именами узлов.
   1. Назначьте **class** в качестве зашифрованного пароля привилегированного режима EXEC.
   1. Назначьте **cisco** в качестве пароля консоли и включите вход в систему по паролю.
   1. Назначьте **cisco** в качестве пароля VTY и включите вход в систему по паролю.
   1. Зашифруйте открытые пароли.
   1. Создайте баннер с предупреждением о запрете несанкционированного доступа к устройству.
   1. Настройте IP-адресации интерфейса, как указано в таблице выше.
   1. Настройте маршрут по умолчанию. от R2 до  R1.
   1. Сохраните текущую конфигурацию в файл загрузочной конфигурации.

*Закройте окно настройки.*
1. ### **Настройте базовые параметры каждого коммутатора.**
   *Откройте окно конфигурации*

   1. Присвойте коммутатору имя устройства.
   1. Отключите поиск DNS, чтобы предотвратить попытки маршрутизатора неверно преобразовывать введенные команды таким образом, как будто они являются именами узлов.
   1. Назначьте **class** в качестве зашифрованного пароля привилегированного режима EXEC.
   1. Назначьте **cisco** в качестве пароля консоли и включите вход в систему по паролю.
   1. Назначьте **cisco** в качестве пароля VTY и включите вход в систему по паролю.
   1. Зашифруйте открытые пароли.
   1. Создайте баннер с предупреждением о запрете несанкционированного доступа к устройству.
   1. Выключите все интерфейсы, которые не будут использоваться.
   1. Настройте IP-адресации интерфейса, как указано в таблице выше.
   1. Сохраните текущую конфигурацию в файл загрузочной конфигурации.

*Закройте окно настройки.*
1. ## **Настройка и проверка NAT для IPv4.**
В части 2 необходимо настроить и проверить NAT для IPv4.
1. ### **Настройте NAT на R1, используя пул из трех адресов 209.165.200.226-209.165.200.228.** 
   *Откройте окно конфигурации*

R1#access-list 1 permit 192.168.1.0 0.0.0.255
R1#ip nat pool PUBLIC\_ACCESS 209.165.200.226 209.165.200.228 netmask 255.255.255.248
R1#ip nat inside source list 1 pool PUBLIC\_ACCESS
R1#interface g0/0/1
R1#ip nat inside
R1#interface g0/0/0
R1#ip nat outside
1. ### **Проверьте и проверьте конфигурацию.** 
   1. С PC-B,  запустите эхо-запрос интерфейса Lo1 (209.165.200.1) на R2. Если эхо-запрос не прошел, выполните процес поиска и устранения неполадок. На R1 отобразите таблицу NAT на R1 с помощью команды **show ip nat translations**.

      C:\>ping 209.165.200.225

      Pinging 209.165.200.225 with 32 bytes of data:

      Request timed out.

      Request timed out.

      Reply from 209.165.200.225: bytes=32 time<1ms TTL=254

      Reply from 209.165.200.225: bytes=32 time<1ms TTL=254

      R1#show ip nat translations

      Pro Inside global Inside local Outside local Outside global

      icmp 209.165.200.226:1 192.168.1.3:1 209.165.200.225:1 209.165.200.225:1

      icmp 209.165.200.226:2 192.168.1.3:2 209.165.200.225:2 209.165.200.225:2

      icmp 209.165.200.226:3 192.168.1.3:3 209.165.200.225:3 209.165.200.225:3

#### icmp 209.165.200.226:4 192.168.1.3:4 209.165.200.225:4 209.165.200.225:4Вопросы:
Во что был транслирован внутренний локальный адрес PC-B?
#### *Внутренний адрес PC-B был транслирован в один из адресов нашего пула*
Какой тип адреса NAT является переведенным адресом?

*Переведенный адрес, т.е. внешний публичный IP-адрес*



1. С PC-A, запустите  эхо-запрос интерфейса Lo1 (**209.165.200.1**) на R2. Если эхо-запрос не прошел, выполните отладку. На R1 отобразите таблицу NAT на R1 с помощью команды **show ip nat translations**.

   R1#show ip nat translations

   Pro Inside global Inside local Outside local Outside global

   icmp 209.165.200.226:5 192.168.1.2:5 209.165.200.1:5 209.165.200.1:5

   icmp 209.165.200.226:6 192.168.1.2:6 209.165.200.1:6 209.165.200.1:6

   icmp 209.165.200.226:7 192.168.1.2:7 209.165.200.1:7 209.165.200.1:7

   icmp 209.165.200.226:8 192.168.1.2:8 209.165.200.1:8 209.165.200.1:8

1. Обратите внимание, что предыдущая трансляция для PC-B все еще находится в таблице. Из S1, эхо-запрос интерфейса Lo1 (**209.165.200.1**) на R2. Если эхо-запрос не прошел, выполните отладку. На R1 отобразите таблицу NAT на R1 с помощью команды **show ip nat translations**.

   R1#show ip nat translations

   Pro Inside global Inside local Outside local Outside global

   icmp 209.165.200.226:2 192.168.1.11:2 209.165.200.1:2 209.165.200.1:2

   icmp 209.165.200.226:3 192.168.1.11:3 209.165.200.1:3 209.165.200.1:3

   icmp 209.165.200.226:4 192.168.1.11:4 209.165.200.1:4 209.165.200.1:4

   icmp 209.165.200.226:5 192.168.1.11:5 209.165.200.1:5 209.165.200.1:5

   icmp 209.165.200.227:10192.168.1.2:10 209.165.200.1:10 209.165.200.1:10

   icmp 209.165.200.227:11192.168.1.2:11 209.165.200.1:11 209.165.200.1:11

   icmp 209.165.200.227:12192.168.1.2:12 209.165.200.1:12 209.165.200.1:12

   icmp 209.165.200.227:9 192.168.1.2:9 209.165.200.1:9 209.165.200.1:9

1. Теперь запускаем пинг R2 Lo1 из S2. На этот раз перевод завершается неудачей, и вы получаете эти сообщения (или аналогичные) на консоли R1:

S2#ping 209.165.200.1

Type escape sequence to abort.

Sending 5, 100-byte ICMP Echos to 209.165.200.1, timeout is 2 seconds:

.....

Success rate is 0 percent (0/5)

1. Это ожидаемый результат, потому что выделено только 3 адреса, и мы попытались ping Lo1 с четырех устройств. Напомним, что NAT — это трансляция «один-в-один». Как много выделено трансляций? Введите команду **show ip nat translations verbose** , и вы увидите, что ответ будет 24 часа.

   R1#show ip nat translations verbose 

   ^

   % Invalid input detected at '^' marker.

1. Учитывая, что пул ограничен тремя адресами, NAT для пула адресов недостаточно для нашего приложения. Очистите преобразование NAT и статистику, и мы перейдем к PAT.

   R1# **clear ip nat translation \*** 

`      `R1#clear ip nat ?

translation Clear dynamic translation

*translation Clear dynamic translation Закройте окно настройки.*
1. ## **Настройка и проверка PAT для IPv4.**
В части 3 необходимо настроить замену NAT на PAT в пул адресов, а затем на PAT с помощью интерфейса.
1. ### **Удалите команду преобразования на R1.**
   *Откройте окно конфигурации*

Компоненты конфигурации преобразования адресов в основном одинаковы; что-то (список доступа) для идентификации адресов, пригодных для перевода, дополнительно настроенный пул адресов для их преобразования и команды, необходимые для идентификации внутреннего и внешнего интерфейсов. Из части 1 наш список доступа (список доступа 1) по-прежнему корректен для сетевого сценария, поэтому нет необходимости воссоздавать его. Мы будем использовать один и тот же пул адресов, поэтому нет необходимости воссоздавать эту конфигурацию. Кроме того, внутренний и внешний интерфейсы не меняются. Чтобы начать работу в части 3, удалите команду, связывающую ACL и пул вместе.

R1(config)# no ip nat inside source list 1 pool PUBLIC\_ACCESS 
1. ### **Добавьте команду PAT на R1.**
Теперь настройте преобразование PAT в пул адресов (помните, что ACL и Pool уже настроены, так что это единственная команда, которую нам нужно изменить с NAT на PAT).

R1(config)# ip nat inside source list 1 pool PUBLIC\_ACCESS overload 
1. ### **Протестируйте и проверьте конфигурацию.**
   1. Давайте проверим, что PAT работает. С PC-B,  запустите эхо-запрос интерфейса Lo1 (209.165.200.1) на R2. Если эхо-запрос не прошел, выполните отладку. На R1 отобразите таблицу NAT на R1 с помощью команды **show ip nat translations**.

R1#show ip nat translations

Pro Inside global Inside local Outside local Outside global

icmp 209.165.200.226:10192.168.1.3:10 209.165.200.1:10 209.165.200.1:10

icmp 209.165.200.226:11192.168.1.3:11 209.165.200.1:11 209.165.200.1:11

icmp 209.165.200.226:12192.168.1.3:12 209.165.200.1:12 209.165.200.1:12

icmp 209.165.200.226:9 192.168.1.3:9 209.165.200.1:9 209.165.200.1:9

Во что был транслирован внутренний локальный адрес PC-B?
#### *Внутренний адрес PC-B был транслирован в один из адресов нашего пула*
Какой тип адреса NAT является переведенным адресом?

*Переведенный адрес, т.е. внешний публичный IP-адрес*

1. С PC-A, запустите эхо-запрос интерфейса Lo1 (209.165.200.1) на R2. Если эхо-запрос не прошел, выполните отладку. На R1 отобразите таблицу NAT на R1 с помощью команды **show ip nat translations**.

   R1#show ip nat translations

   Pro Inside global Inside local Outside local Outside global

   icmp 209.165.200.226:13192.168.1.3:13 209.165.200.1:13 209.165.200.1:13

   icmp 209.165.200.226:14192.168.1.3:14 209.165.200.1:14 209.165.200.1:14

   icmp 209.165.200.226:15192.168.1.3:15 209.165.200.1:15 209.165.200.1:15

   icmp 209.165.200.226:16192.168.1.3:16 209.165.200.1:16 209.165.200.1:16

   icmp 209.165.200.226:17192.168.1.2:17 209.165.200.1:17 209.165.200.1:17

   icmp 209.165.200.226:18192.168.1.2:18 209.165.200.1:18 209.165.200.1:18

   icmp 209.165.200.226:19192.168.1.2:19 209.165.200.1:19 209.165.200.1:19

   icmp 209.165.200.226:20192.168.1.2:20 209.165.200.1:20 209.165.200.1:20

1. Генерирует трафик с нескольких устройств для наблюдения PAT. На PC-A и PC-B используйте параметр -t с командой ping, чтобы отправить безостановочный ping на интерфейс Lo1 R2 (**ping -t 209.165.200.1**), затем вернитесь к R1 и выполните команду **show ip nat translations**:

   R1#show ip nat translations

   Pro Inside global Inside local Outside local Outside global

   icmp 209.165.200.226:1024192.168.1.3:21 209.165.200.1:21 209.165.200.1:1024

   icmp 209.165.200.226:1025192.168.1.3:22 209.165.200.1:22 209.165.200.1:1025

   icmp 209.165.200.226:1026192.168.1.3:23 209.165.200.1:23 209.165.200.1:1026

   icmp 209.165.200.226:1027192.168.1.3:24 209.165.200.1:24 209.165.200.1:1027

   icmp 209.165.200.226:1028192.168.1.3:25 209.165.200.1:25 209.165.200.1:1028

   icmp 209.165.200.226:1029192.168.1.3:26 209.165.200.1:26 209.165.200.1:1029

   icmp 209.165.200.226:1030192.168.1.3:27 209.165.200.1:27 209.165.200.1:1030

   icmp 209.165.200.226:1031192.168.1.3:28 209.165.200.1:28 209.165.200.1:1031

   icmp 209.165.200.226:1032192.168.1.3:29 209.165.200.1:29 209.165.200.1:1032

   icmp 209.165.200.226:1033192.168.1.3:30 209.165.200.1:30 209.165.200.1:1033

   Обратите внимание, что внутренний глобальный адрес одинаков для обоих сеансов. 
   #### Вопрос:
   Как маршрутизатор отслеживает, куда идут ответы? 
   #### *Механизм "overload" позволяет не только переводить внутренние адреса на внешний адрес из пула, но также выполнять перевод портов для обеспечения уникальности идентификации каждого потока трафика.*  
   ** 

1. PAT в пул является очень эффективным решением для малых и средних организаций. Тем не менее есть неиспользуемые адреса IPv4, задействованные в этом сценарии. Мы перейдем к PAT с перегрузкой интерфейса, чтобы устранить эту трату IPv4 адресов. Остановите ping на PC-A и PC-B с помощью комбинации клавиш Control-C, затем очистите трансляции и статистику:

   R1# **clear ip nat translation \*** 

   R1# **clear ip nat statistics** 
1. ### **На R1 удалите команды преобразования nat pool.**
Опять же, наш список доступа (список доступа 1) по-прежнему корректен для сетевого сценария, поэтому нет необходимости воссоздавать его. Кроме того, внутренний и внешний интерфейсы не меняются. Чтобы начать работу с PAT к интерфейсу, очистите конфигурацию, удалив пул NAT и команду, связывающую ACL и пул вместе.

R1(config)#no ip nat inside source list 1 pool PUBLIC\_ACCESS overload 

R1(config)#no ip nat pool PUBLIC\_ACCESS
1. ### **Добавьте команду PAT overload, указав внешний интерфейс.**
Добавьте команду PAT, которая вызовет перегрузку внешнего интерфейса.

R1(config)#ip nat inside source list 1 interface g0/0/0 overload 
1. ### **Протестируйте и проверьте конфигурацию.** 
   1. Давайте проверим PAT, чтобы интерфейс работал. С PC-B,  запустите эхо-запрос интерфейса Lo1 (209.165.200.1) на R2. Если эхо-запрос не прошел, выполните отладку. На R1 отобразите таблицу NAT на R1 с помощью команды **show ip nat translations**.

R1#show ip nat translations

Pro Inside global Inside local Outside local Outside global

icmp 209.165.200.230:39192.168.1.3:39 209.165.200.1:39 209.165.200.1:39

icmp 209.165.200.230:40192.168.1.3:40 209.165.200.1:40 209.165.200.1:40

icmp 209.165.200.230:41192.168.1.3:41 209.165.200.1:41 209.165.200.1:41

1. Сделайте трафик с нескольких устройств для наблюдения PAT. На PC-A и PC-B используйте параметр -t с командой ping для отправки безостановочного ping на интерфейс Lo1 R2 **(ping -t 209.165.200.1**). На S1 и S2 выполните привилегированную команду exec ping 209.165.200.1 повторить 2000. Затем вернитесь к R1 и выполните команду **show ip nat translations**.

R1#show ip nat translations

Pro Inside global Inside local Outside local Outside global

icmp 209.165.200.230:100192.168.1.2:100 209.165.200.1:100 209.165.200.1:100

icmp 209.165.200.230:101192.168.1.2:101 209.165.200.1:101 209.165.200.1:101

icmp 209.165.200.230:1024192.168.1.3:109 209.165.200.1:109 209.165.200.1:1024

icmp 209.165.200.230:1025192.168.1.3:110 209.165.200.1:110 209.165.200.1:1025

icmp 209.165.200.230:1026192.168.1.3:111 209.165.200.1:111 209.165.200.1:1026

icmp 209.165.200.230:1027192.168.1.3:112 209.165.200.1:112 209.165.200.1:1027

icmp 209.165.200.230:1028192.168.1.3:113 209.165.200.1:113 209.165.200.1:1028

icmp 209.165.200.230:1029192.168.1.3:114 209.165.200.1:114 209.165.200.1:1029

Теперь все внутренние глобальные адреса сопоставляются с IP-адресом интерфейса g0/0/0.

Остановите все пинги. На PC-A и PC-B, используя комбинацию клавиш CTRL-C.

*Закройте окно настройки.*
1. ## **Настройка и проверка статического NAT для IPv4.**
В части 4 будет настроена статическая NAT таким образом, чтобы PC-A был доступен напрямую из Интернета. PC-A будет доступен из R2 по адресу 209.165.200.229.

**Примечание.** Конфигурация, которую вы собираетесь завершить, не соответствует рекомендуемым практикам для шлюзов, подключенных к Интернету. Эта лаборатория полностью опускает стандартные методы безопасности, чтобы сосредоточиться на успешной конфигурации статического NAT. В производственной среде решающее значение для удовлетворения этого требования будет иметь тщательная координация между сетевой инфраструктурой и группами безопасности. 
1. ### **На R1 очистите текущие трансляции и статистику.**
   *Откройте окно конфигурации*

R1# **clear ip nat translations \*** 

R1# **clear ip nat statistics** 
1. ### **На R1 настройте команду NAT, необходимую для статического сопоставления внутреннего адреса с внешним адресом.**
Для этого шага настройте статическое сопоставление между 192.168.1.11 и 209.165.200.1 с помощью следующей команды:

R1(config)# **ip nat inside source static 192.168.1.2 209.165.200.229** 
1. ### **Протестируйте и проверьте конфигурацию.**
   1. Давайте проверим, что статический NAT работает. На R1 отобразите таблицу NAT на R1 с помощью команды **show ip nat translations**, и вы увидите статическое сопоставление.

      R1# show ip nat translations

      Pro Inside global Inside local Outside local Outside global

      --- 209.165.200.229 192.168.1.2 --- ---

   1. Таблица перевода показывает, что статическое преобразование действует. Проверьте это, запустив ping  с R2 на 209.165.200.229. Плинги должны работать.

      Примечание. Возможно, вам придется отключить брандмауэр ПК для работы pings.

   1. На R1 отобразите таблицу NAT на R1 с помощью команды **show ip nat translations**, и вы увидите статическое сопоставление и преобразование на уровне порта для входящих pings.

      R1# **show ip nat translations**

      Pro Inside global Inside local Outside local Outside global

      --- 209.165.200.229 192.168.1.2 --- ---

      229:3 192.168.1. 2:3 209.165.200. 225:3 209.165.200. 225:3 209.165.200. 

      Total number of translations: 2

      Это подтверждает, что статический NAT работает.

*Закройте окно настройки.*

© ã 2016 г. - гггг Корпорация Cisco и/или ее дочерние компании. Все права защищены. Открытая информация Cisco 	страница 6** 6**	www.netacad.com
