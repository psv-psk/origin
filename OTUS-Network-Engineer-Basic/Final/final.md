### Цели работы ###
1. Модернизация технологической сети voip провайдера.
2. Обеспечение отказоустойчивости сети.
3. Обеспечение безопасности сети.
4. Бэкап сетевых настроек и логов сетевых устройств.

### Что планировалось ###
1. Добавление второго коммутатора L3 в сеть.
2. Обеспечение отказоустойчивости сети.
3. Внедрение технологий управления трафиком.
4. Доступность серверов из WAN.
5. Настройка GRE тоннелей

### Используемые технологии ###
1. VLAN
2. VRRP (Virtual Router Redundancy Protocol)
3. STP
4. DHCP
5. QoS
6. NTP
7. SYSLOG
8. GRE/IPSec

### Анализ и схема существующей сети ###

![](до.png)
Изначально сеть состоит из 2-х роутеров Mikrotik CCR1009-1G-C-15plus
- 1-ый маршрутизатор(Cogent-GW) не является шлюзом, но на нем базируется вся сеть стойки. То есть тут выдается DHCP, VLAN, WireGuard, туннели и так далее.
- 2-ой (Serverius-GW) для gre тунелей и на нем используюься ip адреса Serverius
- коммутатор Huawei S5720S-52X-SI-AC, к который выполняет роль ядра сети. К коммутатору приходит интернет от двух провайдеров Cogent и Serverius и сюда подключены все серверы.

### Анализ использованных технологий: #
На роутерах настроены ACL для разграничения прав доступа к сетям.
Почти все Ip адреса задаются в ручную(static) 
Для связи между дата центрами используется GRE-тунель 

### Провести оценку производительности сети: #
В целом производительности сети на данный момент хватает

### Идентификация узких мест и проблемных зон: #
Так как сеть используется для передачи медиа трафика(UDP), то периодически возникают проблемы с потерей пакетов, что критично для конечных абонентов


** Предлагается добавлениюе второго коммутатора и обеспечению полного резервирования каналов и оборудования: **


### 1. Добавление второго коммутатора Huawei S5720S-52X-SI-AC:
- Установливаем второй коммутатор для повышения отказоустойчивости сети и увеличения пропускной способности.
- Настроиваем второй коммутатор таким образом, чтобы он мог настроиться на работу как резервный для первого коммутатора в случае возникновения проблем или отказа основного устройства.

### 2. Резервирование каналов:
- Подключаем каждый коммутатор к обоим провайдерам интернета (Cogent и Serverius) для обеспечения непрерывного доступа к сети в случае отказа одного из провайдеров.
- Настроиваем маршрутизацию с использованием протоколов OSPF или BGP для автоматического переключения трафика между провайдерами в случае обрыва канала.

### 3. Обеспечение резервирования оборудования:
- Создаем дублирующие конфигурации на обоих роутерах Mikrotik для быстрого восстановления настроек в случае сбоя в основном устройстве.
- Установливаем процедуры и инструменты для мониторинга работоспособности оборудования и автоматического переключения на резервное оборудование при обнаружении проблем.


# 1. Добавление второго коммутатора Huawei

![](после22.png)

Для добавления второго коммутатора Huawei S5720S-52X-SI-AC в сеть и настройки его как резервного устройства для повышения отказоустойчивости и увеличения пропускной способности, можно выполнить следующие шаги:

### Общая таблица сетей. ###

|Network IPv4     	|Description
|-------------------|------------------------|
|10.8.230.0/24	    |Serverius local network |	
|10.8.240.0/24  	  |Gogent local network	   |
|66.249.44.224/27 	|Serverius network	     |
|55.255.64.208/28	  |Gogent network	         |
|77.155.208.230/28	|Xelent network	         |

Пример расчета подсетей 10.8.230.0 и 10.8.240.0 с числом хостов = 254

Для создания двух подсетей на основе адресов 10.8.230.0 и 10.8.240.0 с необходимым количеством хостов(254), мы можем использовать следующие подсети:

1. Подсеть 10.8.230.0:
   - Адрес подсети: 10.8.230.0
   - Маска подсети: 255.255.255.0 (/24)
   - Эта подсеть поддерживает 2^8 - 2 = 254 хостов.

2. Подсеть 10.8.240.0:
   - Адрес подсети: 10.8.240.0
   - Маска подсети: для поддержки максимального количества хостов, мы можем использовать маску подсети 255.255.255.0 (/24) или даже 255.255.252.0 (/22), чтобы увеличить количество доступных хостов.
   - При использовании маски подсети 255.255.252.0 (/22), данная подсеть сможет поддерживать 2^10 - 2 = 1022 хоста.
### 1.1 Физическое подключение:
- Установливаем второй коммутатор Huawei S5720S-52X-SI-AC в сеть, подключив его к уже существующей сети с использованием высокоскоростных соединений (Ethernet или оптические кабели).
- Подключаем второй коммутатор к тому же оборудованию, к которому подключен первый коммутатор (сервера, маршрутизаторы, провайдеры интернета и т. д.).

### 1.2 Конфигурация второго коммутатора:
- Настроиваем IP-адрес и базовые настройки второго коммутатора для его подключения к сети.
- Настраиваем VLAN, trunk-порты и другие необходимые параметры коммутатора в соответствии с текущей конфигурацией сети.

1.2.1 *Настройка IP-адреса и базовых параметров:*
```
Switch> enable
Switch# configure terminal
Switch(config)# hostname SW-Cogent
SW-Cogent(config)# interface vlan 1
SW-Cogent(config-if)# ip address 192.168.1.2 255.255.255.0
SW-Cogent(config-if)# no shutdown
SW-Cogent(config-if)# exit
SW-Cogent(config)# exit
```

1.2.2 *Настройка VLAN и trunk-портов:*

|VLANs	|Description	|
|------------|--------------|
|Vlan10	|MTS	|
|Vlan11	|Beeline|	
|Vlan12	|Megafon	|
|Vlan13	|Inet for TS|	
|Vlan14	|vpbx	|

```
SW-Cogent(config)# vlan 10
SW-Cogent(config-vlan)# name MTS
SW-Cogent(config)# vlan 13
SW-Cogent(config-vlan)# name Inet for TS
SW-Cogent(config)# interface gigabitethernet 0/1
SW-Cogent(config-if)# switchport mode trunk
SW-Cogent(config-if)# switchport trunk allowed vlan 10,13
SW-Cogent(config)# interface gigabitethernet 0/2
SW-Cogent(config-if)# switchport mode access
SW-Cogent(config-if)# switchport access vlan 10
```

1.2.3 *Сохранение конфигурации:*
```
SW-Cogent# copy running-config startup-config
```

### 1.3 Настройка VRRP (Virtual Router Redundancy Protocol):
- Настраеваем VRRP на обоих коммутаторах для обеспечения отказоустойчивости между ними.
- Настраиваем второй коммутатор в качестве резервного (backup) устройства, которое автоматически принимает на себя работу основного коммутатора в случае его отказа.

Для настройки VRRP (Virtual Router Redundancy Protocol) на обоих коммутаторах можно использовать следующие команды:

1.3.1 *Настройка основного коммутатора (Primary):*
```
SW-Serverius> enable
SW-Serverius# configure terminal
SW-Serverius(config)# interface vlan 1
SW-Serverius(config-if)# vrrp 1 ip 10.8.230.1
SW-Serverius(config-if)# vrrp 1 priority 110
SW-Serverius(config-if)# vrrp 1 preempt
SW-Serverius(config-if)# exit
SW-Serverius(config)# exit
```

1.3.2. *Настройка резервного коммутатора (Backup):*
```
SW-Cogent> enable
SW-Cogent# configure terminal
SW-Cogent(config)# interface vlan 1
SW-Cogent(config-if)# vrrp 1 ip 10.8.230.1
SW-Cogent(config-if)# vrrp 1 priority 100
SW-Cogent(config-if)# exit
SW-Cogent(config)# exit
```
В этом примере настроен VRRP на коммутаторах. Основной коммутатор имеет более высокий приоритет (110), что позволяет ему быть основным устройством, а резервный коммутатор имеет приоритет 100. Параметр "preempt" на основном коммутаторе позволяет ему вернуться в роль основного устройства после восстановления.


# 2. Резервирование каналов:

Для резервирования каналов и обеспечения непрерывного доступа к сети при использовании двух провайдеров интернета (Cogent и Serverius), можно выполнить следующие шаги:

### 2.1 Физическое подключение:
- Подключаем каждый коммутатор к обоим провайдерам интернета (Cogent и Serverius) с использованием отдельных выделенных линий или портов для каждого провайдера.
- Убеждаемся в правильном подключении и наличии резервных маршрутов для обоих провайдеров.

### 2.2 Настройка маршрутизации:
- Настраиваем статические маршруты к каждому провайдеру с заданием Administrative Distance (AD) для каждого маршрута. AD определяет приоритет маршрута в таблице маршрутизации.

2.2.1. *Создание статического маршрута к первому провайдеру:*
```
SW-Serverius(config)# ip route 0.0.0.0 0.0.0.0 55.255.64.209 5
```
- ip route 0.0.0.0 0.0.0.0 - указывает, что данный маршрут будет использоваться для всех пакетов, не адресованных в локальную сеть
- IP адрес следующего хопа к первому провайдеру
- 5 - значение Administrative Distance для этого маршрута

2.2.2. *Создание статического маршрута к второму провайдеру (в качестве резервного):*
```
SW-Serverius(config)# ip route 0.0.0.0 0.0.0.0 55.255.64.211 10
```
- backup IP адрес следующего хопа ко второму провайдеру
- 10 - значение Administrative Distance для этого резервного маршрута, которое выше значения AD первого маршрута

Таким образом, при использовании плавающей статики, маршрутизатор будет предпочитать маршрут с более низким значением AD. Если первый провайдер недоступен, маршрутизатор автоматически переключится на резервный маршрут с более высоким значением AD.

2.2.3. *Сохранение изменений в конфигурации:*
```
SW-Serverius# write memory
```
3. Настройка маршрутных политик:
- Настраиваем маршрутные политики для определения приоритетов маршрутов и условий переключения трафика между провайдерами.
- Установливаем механизмы контроля качества обслуживания (QoS) для предоставления приоритета трафику в зависимости от его важности.

Для настройки маршрутных политик и механизмов контроля качества обслуживания (QoS) на коммутаторах Cisco, используйте следующие примеры команд:

3.1. Настройка маршрутных политик:
```
SW-Serverius> enable
SW-Serverius# configure terminal
SW-Serverius(config)# ip route 0.0.0.0 0.0.0.0 10.8.230.2 100
SW-Serverius(config)# ip route 0.0.0.0 0.0.0.0 10.8.240.2 200
SW-Serverius(config)# exit
```

3.2. Настройка механизмов QoS:

Для настройки механизмов QoS (Quality of Service) на коммутаторе Cisco для VoIP трафика, следует выполнить следующие шаги:
3.2.1 Создадим классификацию трафика VoIP с помощью ACL (Access Control List).
3.2.2 Создадим класс маршрутизации (class-map), который соответствует этому ACL.
3.2.3 Создадим политику QoS (policy-map) для управления трафиком VoIP. Назовем ее VOIP-POLICY.

```
SW-Serverius> enable
SW-Serverius# configure terminal
SW-Serverius(config)# access-list 100 permit udp any any range 16384 32767
SW-Serverius(config)# class-map match-any VOIP
SW-Serverius(config-cmap)# match access-group 100
SW-Serverius(config-cmap)# exit
SW-Serverius(config)# policy-map VOIP-POLICY
SW-Serverius(config-pmap)# class VOIP
SW-Serverius(config-pmap-c)# set dscp ef
SW-Serverius(config-pmap-c)# priority percent 30
SW-Serverius(config-pmap-c)# exit
SW-Serverius(config-pmap)# exit
SW-Serverius(config)# interface GigabitEthernet0/1
SW-Serverius(config-if)# service-policy input VOIP-POLICY
SW-Serverius(config-if)# exit
SW-Serverius(config)# exit
```

В этих примерах настроены маршрутные политики для установления приоритетов маршрутов с помощью команд ip route и установлены механизмы QoS с использованием классификации трафика (access-list и class-map), определения политики QoS (policy-map) и применения политики на интерфейсе (service-policy).


# 3. Обеспечение резервирования оборудования:

Для обеспечения резервирования оборудования и быстрого восстановления работы в случае сбоя основного устройства, можно выполнить следующие шаги:

### 3.1. Создание дублирующих конфигураций:
3.1.1 *Конфигурируем оба роутера Mikrotik с идентичными настройками и параметрами сети.*

- Настройки интерфейсов: IP адреса, VLAN, порты и т.д.
- Настройки маршрутизации: статические маршруты, OSPF, BGP и другие протоколы маршрутизации.
- Настройки безопасности: фильтры, правила брандмауэра, VPN и т.д.
- Настройки сервисов: DHCP, DNS, NTP и другие сервисы.
  
3.1.2. Периодически обновляйте и синхронизируйте конфигурации обоих роутеров для поддержания актуальности и соответствия. Рекомендуется создать расписание для регулярной синхронизации конфигураций.

3.1.3. Резервное копирование конфигураций: после каждого обновления или внесения изменений в конфигурацию, сделайте резервное копирование конфигурации обоих роутеров. Это поможет быстро восстановить работоспособность в случае сбоя или потери конфигурации.

### 3.2. Установка процедур и инструментов мониторинга:

Шаги для установки процедур и инструментов мониторинга на роутерах Mikrotik:

3.2.1. *Выбор инструментов мониторинга: необходимо выберать подходящие инструменты для мониторинга сети Mikrotik, такие как SNMP, Syslog, или сторонние мониторинговые программы.*

3.2.2. *Настройка SNMP (Simple Network Management Protocol):*
   - Включаем и настраивааем SNMP на обоих роутерах Mikrotik.
   - Настраиваем параметры SNMP, такие как комьюнити строку, версию протокола, ограничения доступа и т.д.
   - Указываем IP адреса серверов, на которые будут посылаться SNMP уведомления.

3.2.3. *Настройка Syslog:*
   - Включаем и настраиваем Syslog на роутерах Mikrotik для сбора и анализа логов системы.
   - Указываем IP адрес и порт сервера Syslog, на который будут отправляться логи.
   - Настраиваем уровни логирования и фильтры для выборочного сбора информации.

3.2.4. *Развертывание мониторинговых программ:*
   - Устанавливаем и конфигурируем мониторинговые программы на серверах, которые будут принимать данные от роутеров Mikrotik.
   - Настраиваем алерты, отчеты и дашборды для отслеживания состояния сети и роутеров.

3.2.5. *Тестирование и мониторинг:*
   - После настройки всех инструментов нужно убедиться, что данные правильно поступают на серверы мониторинга.
   - Провести тесты мониторинга для проверки эффективности и работоспособности системы мониторинга.

### 3.3. Организация резервного оборудования:
- Необходимо подготовить резервное оборудование, настроив его заранее с идентичными настройками основного устройства.

